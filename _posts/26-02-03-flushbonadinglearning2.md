---
layout: post
title: STM入门学习记录2
categories: STM32
description: STM入门学习记录
keywards: note,record,STM32
mermaid: true
mathjax: true
---

STM32入门学习记录2：GPIO输出

学习自江协科技 [STM32入门教程-2023版 细致讲解 中文字幕](https://www.bilibili.com/video/BV1th411z7sn/?p=4&share_source=copy_web&vd_source=67b9019751b1734c92e834bdee04be24)

# 一、简介
GPIO，即(General Purpose Input Output) 通用输入输出口，可配置为8种输入输出模式  
引脚电平：0V~3.3V，部分(带FT的)引脚可容忍5V,输出只能最高3.3V(电源为3.3V)  

![](/images\posts\record\STM32F103C8T6-pin-definition.png)  

### 1. 输出模式
- 可控制端口高低电平，故只要是可以用高低电平控制的地方都可以用GPIO来完成，若控制的是大功率设备，只需加入驱动电路即可
- 还可用于模拟通讯协议的输出时序部分，如I2C,SPI等  

### 2. 输入模式
- 可读取端口高低电平或电压，用于按键输入，外接模块(带有数字输出，如光敏、热敏电阻)电平信号输入，(若输出的是模拟量，还可配置为模拟输入模式，配合ADC外设读取端口模拟电压)ADC电压采集，模拟通讯协议接收数据等  
  
### 3. 结构

![](/images\posts\record\GPIO-basic-structure.png)  

如图 寄存器为32位，前十六位对应十六个引脚，后十六位为空，在APB2总线上

![](/images\posts\record\GPIO-pin-structure.png)

#### 上/下拉输入

如图 因引脚悬空时状态不稳定，易受外界扰动，故有上/下拉电阻，上拉即为默认为高电平的输入模式，下拉反之 

#### 输出

输出数据寄存器只能整体读写，若想单独控制某一端口而不影响其他端口，可通过以下两种方式  
- 读出寄存器，用按位与或按位或的方式更改某一位(c语言的`&=` `|=` 与等对应位为1则不变，对应位0则为0，或等反之)再将更改后的数据写回
- (**库函数的实现方式**) 设置位设置/清除寄存器，若想将某位写为1，则将**位设置寄存器**对应位写为1，若想将某位写为0则将**位清除寄存器**对应位写1，写0的位均保持不变
- 读写STM32中的位带位置，stm32中专门分配有一段地址区域映射RAM和外设寄存器的每一位，读写这段地址的数据就相当于读取所映射位置的某一位  

##### 推挽输出
P-MOS和N-MOS均有效，且有强驱动能力，故推挽输出也叫强推模式，数据寄存器为1时，上管导通下管断开，输出高电平；为0则反之，该模式下32对IO口具有绝对控制权

##### 开漏输出
该输出模式仅N-MOS工作    
- 数据寄存器1时，N-MOS断开，高阻模式，可外接上拉电阻5V输出
- 数据寄存器为0，下管导通，接VSS，输出低电平，低电平有驱动能力，高电平没有
- 可作为通讯协议的驱动方式（I2C通讯引脚），多机通信时，该模式可以避免各个设备相互干扰

##### 关闭模式
引脚配置为输入模式时，P-MOS、N-MOS均无效，端口电平由外部信号控制  

### 4. GPIO八大模式
同[前文]({% post_url 26-01-22-flushbonadinglearning1 %})提及

<center>

| 模式名称 | 性质 | 特征 |
| :---: | :---: | :---: |
| 浮空输入 | 数字输入 | 可读取引脚电平，若引脚悬空，则电平不确定 |
| 上拉输入 | 数字输入 | 可读取引脚电平，内部连接上拉电阻，悬空时默认高电平 |
| 下拉输入 | 数字输入 | 可读取引脚电平，内部连接下拉电阻，悬空时默认低电平 |
| 模拟输入 | 模拟输入 | GPIO无效，引脚直接接入内部ADC |
| 开漏输出 | 数字输出 | 可输出引脚电平，高电平为高阻态，低电平接VSS |
| 推挽输出 | 数字输出 | 可输出引脚电平，高电平接VDD，低电平接VSS |
| 复用开漏输出 | 数字输出 | 由片上外设控制，高电平为高阻态，低电平接VSS |
| 复用推挽输出 | 数字输出 | 由片上外设控制，高电平接VDD，低电平接VSS |

</center>

- 浮空输入时必须接入连续驱动源，不能出现悬空情况
- 右侧保护二极管上VDD_FT(如图)对容忍5V的接口是特殊的 外部接5v时要特殊处理，否则二极管导通会产生大电流
- 在输出模式下 输入模式也有效，而输入模式下输出无效，因为一个端口只能有一个输出，但是可以有多个输入

![](/images\posts\record\AFPP_AFOD.png)  
  
### 5. GPIO寄存器

**<font color=green>详情可查阅参考手册</font>**
- 端口配置寄存器分高低两个共64位，因为一个端口配置需要四位，具体查阅参考手册
- 端口输入数据寄存器低16位对应16引脚，高16位未使用
- 端口输出数据寄存器同上
- 端口位设置/清除寄存器的高16位为位清除，低16位为位设置
- 端口位清除寄存器低16位同上高16位，方便操作
- 端口配置锁定寄存器：对端口配置锁定防止意外修改

若想对多个端口进行位设置和位清除则用一体的即可，确保同步性

# 二、外部设备电路

### 小功率外设
直接用IO口驱动，注意高低电平

### 大功率外设
IO口控制驱动电路间接控制，如三极管，PNP低电平，NPN反之(发射结正偏)

# 三、程序实例

### 1. LED闪烁
